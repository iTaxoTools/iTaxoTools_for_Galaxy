<tool id="MolD" name="MolD" version="0.1.0+galaxy0" python_template_version="3.5" profile="21.05">
    <description>DNA diagnoses for pre-defined taxa</description>
    <requirements>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
      echo -e "INPUT_FILE=$input1 \n
               OUTPUT_FILE=$output1 \n
               qTAXA= 
               #if $pattern !="*" and not $pattern_merged 
                P:$pattern \n
               #elif $pattern_merged
                 P+:$pattern  \n
               #elif $morethanN > 0
                  >$morethanN \n
               #else
                 $select_taxa.taxa_select   \n
               #end if
                Taxon_rank=$rank \n
                Gaps_as_chars=$gaps \n
                Cutoff=$adv_opt.cutoff \n
                NumberN=$adv_opt.numn \n
                Number_of_iterations=$adv_opt.numi \n
                MaxLen1=$adv_opt.maxlen1 \n
                MaxLen2=$adv_opt.maxlen2 \n
               #if $adv_opt.iref=="NO"
                 Iref=$adv_opt.iref \n
               #elif $adv_opt.iref_mode
                 Iref=$adv_opt.iref, in  \n
               #else
                 Iref=$adv_opt.iref, ex  \n
               #end if
                Pdiff=$adv_opt.pdiff \n
                PrSeq=$adv_opt.PrSeq \n
                NMaxSeq=$adv_opt.nmaxseq \n
                Scoring=$adv_opt.scoring \n" >params.txt &&

       python $__tool_directory__/MolD_v1.4.py -i params.txt >$output2
      
    ]]></command>

    <inputs>
      <param  type="data" name="input1" label="Source file" format="fasta" />
      <section name="select_taxa" title="See taxa for selection">
        <param name="taxa_select" type="select" display="checkboxes" multiple="true" checked="true" label="Choose taxa to diagnose">
          <options from_dataset="input1" startswith=">" >
             <column name="name" index="0"/>
             <column name="value" index="0"/>
             <filter type="multiple_splitter" column="0" separator="|"/>
             <filter column="0" type="regexp" value=">" keep="false" />
              <filter column="0" type="sort_by" />
              <filter type="unique_value" name="unique_taxon" column="0"/>
           </options>
        </param>
      </section>
      <param name="morethanN" type="integer" label="N of sequences" value="0" help="Only taxa with more than N sequences are to be diagnosed (overrides selection!)" />
      <param name="pattern"  type="text" label="Pattern" value="*" help="Only taxa with certain pattern in the taxon name are to be diagnosed (overrides selection!)" />
      <param name="pattern_merged"  type="boolean" checked="false" label="Merge"  help="Merge taxa with above pattern before diagnosis"/>
     <param name="rank"  type="boolean" checked="true" label="Taxon Rank" truevalue="1" falsevalue="2" help="Set taxon rank: if species true(1), if above species false(2)"/>
      <param name="gaps"  type="boolean" label="Gaps as chars"  help="Code gaps as characters: yes or no"/>
        <section name="adv_opt" title="Advanced parameters for pDNC recovery">
          <param name="cutoff"  type="text" label="Cutoff" value="100" help="Set number of the informative positions to be considered (default 100) or use '> + integer' to set desired cutoff value (for example '> 1')" />
         <param name="numn" type="integer" label="Number N" value="5" help="Set how many ambiguously called nucleotides are allowed (default 5)" />
          <param name="numi" type="integer" label="Number i" value="10000" help="Set number recursions of MolD (default 10000)" />
         <param name="maxlen1" type="integer" label="MaxLen1" value="12" help="Set maximum length for the raw pDNCs (defailt 12)" />
         <param name="maxlen2" type="integer" label="MaxLen2" value="7" help="Set maximum length for the refined pDNCs (default 7)" />
         <param name="iref"  type="text" label="Index reference" value="NO" help="Set a sequence to be used as a reference for site indexing (default NO)" />
         <param name="iref_mode"  type="boolean" checked="true" label="Index mode"  help="Yes, if seqence will be used for diagnoses calculations or No if seq is to be used for indexin only"/>
         <param name="pdiff"   type="integer" optional="true" label="PDiff" value="" help="Set percent difference between original and modified sequence (default 1 for species-level taxa, 3 for for supraspecific taxa)" />    
         <param name="PrSeq" type="float" optional="true" label="PrSeq" value="" help="Set proportion of sequences in the dataset to be modified (default 0.5 for species-level, and 0.1 for supraspecific taxa)." />
         <param name="nmaxseq" type="integer" label="NMaxSeq" value="10" help="Set max number of sequences per taxon to modify (default 10)" />
         <param  type="select" name="scoring" label="Scoring" help="Set threshold of sDNC rating(default moderate 75)">
           <option value="lousy">Lousy (66)</option>
           <option value="moderate" selected="true">Moderate (75)</option>
           <option value="stringent" >Stringent (90)</option>
           <option value="very stringent">Very stringent (95)</option>
         </param>
      </section>
    </inputs>

    <outputs>
      <data name="output1" label="MolD: ${os.path.splitext($input1.name)[0]}.html" format="html"/>
      <data name="output2" label="MolD: ${os.path.splitext($input1.name)[0]}.txt" format="txt"/>
    </outputs>
    <tests>
      <test>
          <param name="input1" value="Example_input_alignment_Pontohedyle_COI.fas"/>
          <param name="taxa_select" value="milaschewitchii,neridae"/>
          <output name="output2">
            <assert_contents>
              <has_text text="milaschewitchii"/>
            </assert_contents> 
          </output>
      </test>
  </tests>
  
    <help><![CDATA[
**About MolD**
* A program to identify robust sets of diagnostic sites for pre-defined taxa from DNA sequences, using a tree independent algorithm to retrieve diagnostic nucleotide 
characters.*
*This Galaxy version implements MolD 1.4, developed 2022.* 
*MolD was written in Python by Alexander Fedosov.*
*The Galaxy wrapper was developed by F. Fischell in the framework of the iTaxoTools project in 2022/2023. Only tested for fasta alignment files. Transition and seed parameters are not currently supported. Tamura-Nei distance calculation is either really slow or broken, we recommend not using it.*
Standalone executables with graphical user interface of the newest version of MolD are available for Windows and Mac from:
http://itaxotools.org/
https://github.com/iTaxoTools/iTaxoTools-Executables/releases
For detailed instructions on the use of MolD and interpretation of results, see the iTaxoTools manual available at:
http://itaxotools.org/


**MolD 1.4**
This program is tailored for seamlessly recovering DNA-based diagnoses from large DNA datasets and is capable of identifying diagnostic combinations of nucleotides (DNCs) in addition to single (pure) diagnostic sites, enabling users to base DNA diagnoses on a minimal number of diagnostic sites necessary for a reliable differentiation of taxa, rather than providing a long list of such sites. 
The MolD algorithm assembles DNA diagnoses that fulfill pre-defined criteria of reliability, which is achieved by repeatedly scoring diagnostic nucleotide combinations against datasets of in silico mutated sequences. 
Version 
Version 1.4 has several improved functionalities, in particular the output files produced are better documented and more easy to interpret for unexperienced users. 

* Note: several new features of the version 1.4 od MolD are not yet implemented in the Galaxy version; in particular the option to output lists of pairwise diagnostic sites among nucleotides is missing:*


*Input files*
Input is a fasta file of aligned sequence files (for best performance of the program, without missing data and indels)  where each entry starts with the identifier line, and one or more lines of nucleotide sequence. Identifier line starts with ‘>’ and must contain two parts, separated by a pipe (‘|’) symbol. The first part is a free-style sequence identifier. The names of the taxa to be diagnosed correspond to the second element, i.e., the taxon identifier: >SequenceID####|taxon. The taxon identifier corresponds to the name of the species, genus etc to which you assign this sequence. For more details, see the iTaxoTools manual and example files for MolD at http://itaxotools.org/

*Settings*
1. Specify the taxon rank of your query taxa. In most cases these will correspond to species or species-level OTUs. If your specified taxa instead correspond to supraspecific units such as  genera or species groups, it is useful to change the setting accordingly to "supraspecific taxa" (in the parameter file: 1 for species, 2 for supraspecific taxa). The specified taxon rank will influence the maximum divergence allowed when simulating sequences in the last step in MolD. 
2. Specify if gaps should be coded as characters or as missing data. If specifying “Yes”, dashes (‘-‘) in the alignment are transformed into ‘D’ characters and these treated as independent character states. If specifying “No” dashes are treated as missing data (‘N’). 
3. For advanced settings, see the iTaxoTools manual at http://itaxotools.org/

**Output**
The  output file summarizes the main output of the MolD algorithm. After recapitulating the main parameter settings, it provides for each of the taxa selected for the analysis, and basoic information for each taxon. Most importantly, the file includes for each taxon a final "robust Diagnostic Nucleotide Combination" (rDNC) as well as a diagnosis text that can be copy-pasted into the respective section of a research paper for the purpose of diagnosing a taxon. Note that the rDNC is a diagnostic combination of positions, i.e., only the combination of the listed positions will provide a robust diagnosis (while each position on its own might or might not be universally diagnostic).


    ]]></help>
      <citations>
        <citation type="doi">
          10.1101/838151
        </citation>
        <citation type="doi">
            10.11646/megataxa.6.2.1 
        </citation>
      </citations>
</tool>
