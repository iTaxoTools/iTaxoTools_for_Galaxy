<tool id="MolD" name="MolD" version="0.1.0+galaxy0" python_template_version="3.5" profile="21.05">
    <description>DNA diagnoses for pre-defined taxa</description>
    <requirements>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
      echo -e "INPUT_FILE=$input1 \n
               OUTPUT_FILE=$output1 \n
               qTAXA=$show_select.taxa \n
               Taxon_rank=$rank \n
               Gaps_as_chars=$gaps \n
               Cutoff=$adv_opt.cutoff \n
               NumberN=$adv_opt.numn \n
               Number_of_iterations=$adv_opt.numi \n
               MaxLen1=$adv_opt.maxlen1 \n
               MaxLen2=$adv_opt.maxlen2 \n
               Pdiff=$adv_opt.pdiff \n
               PrSeq=$adv_opt.PrSeq \n
               NMaxSeq=$adv_opt.nmaxseq \n
               Scoring=$adv_opt.scoring \n" >params.txt &&

       $__tool_directory__/MolD_Galaxy -i params.txt >$output2

    ]]></command>


    <inputs>
      <param  type="data" name="input1" label="Source file" format="fasta,phylip,csv" />
      <conditional name="show_select">
        <param name="all_taxa"  type="select" display="radio" label="All taxa" help="Set list of the focus taxa">
          <option value="all">All taxa</option>
          <option value="select" selected="true">Selected taxa</option>
      </param>

        <when value="select">
          <param name="taxa" type="select" display="checkboxes" multiple="true" checked="true" label="Choose taxa">
            <options from_dataset="input1" startswith=">" >
               <column name="name" index="0"/>
               <column name="value" index="0"/>
               <filter type="multiple_splitter" column="0" separator="|"/>
               <filter column="0" type="regexp" value=">" keep="false" />
               <filter column="0" type="sort_by" />
               <filter type="unique_value" name="unique_taxon" column="0"/>
            </options>
         </param>
         </when>
         <when value="all">
          <param name="taxa" type="hidden" value="ALL"/>
        </when>
      </conditional>
      <param name="rank"  type="boolean" checked="true" label="Taxon Rank" truevalue="1" falsevalue="2" help="Set taxon rank: if species true(1), if above species false(2)"/>
      <param name="gaps"  type="boolean" label="Gaps as chars"  help="Code gaps as characters: yes or no"/>
      <section name="adv_opt" title="Advanced parameters for pDNC recovery">
        <param name="cutoff"  type="text" label="Cutoff" value="100" help="Set number of the informative positions to be considered (default 100) or use '> + integer' to set desired cutoff value (for example '> 1')" />
        <param name="numn" type="integer" label="Number N" value="25" help="Set how many ambiguously called nucleotides are allowed (default 25)" />
        <param name="numi" type="integer" label="Number i" value="10000" help="Set number recursions of MolD (default 10000)" />
        <param name="maxlen1" type="integer" label="MaxLen1" value="12" help="Set maximum length for the raw pDNCs (defailt 12)" />
        <param name="maxlen2" type="integer" label="MaxLen2" value="7" help="Set maximum length for the refined pDNCs (default 7)" />
        <param name="pdiff"   type="integer" optional="true" label="PDiff" value="" help="Set percent difference between original and modified sequence (default 1 for species-level taxa, 3 for for supraspecific taxa)" />    
        <param name="PrSeq" type="float" optional="true" label="PrSeq" value="" help="Set proportion of sequences in the dataset to be modified (default 0.5 for species-level, and 0.1 for supraspecific taxa)." />
        <param name="nmaxseq" type="integer" label="NMaxSeq" value="10" help="Set max number of sequences per taxon to modify (default 10)" />
        <param  type="select" name="scoring" label="Scoring" help="Set threshold of sDNC rating(default Stringent (90))">
          <option value="lousy">Lousy (66)</option>
          <option value="moderate">Moderate (75)</option>
          <option value="stringent" selected="true">Stringent (90)</option>
          <option value="very stringent">Very stringent (95)</option>
        </param>
      </section>
    </inputs>

    <outputs>
      <data name="output1" label="MolD: ${os.path.splitext($input1.name)[0]}.html" format="html"/>
      <data name="output2" label="MolD: ${os.path.splitext($input1.name)[0]}.txt" format="txt"/>
    </outputs>
    <tests>
      <test>
          <param name="input1" value="Example_input_alignment_Pontohedyle_COI.fas"/>
          <param name="taxa" value="milaschewitchii,neridae"/>
          <output name="output2">
            <assert_contents>
              <has_text text="milaschewitchii"/>
            </assert_contents> 
          </output>
      </test>
  </tests>
  
    <help><![CDATA[
**MolD 1.3**

Python implementation of DNA diagnoses for pre-defined taxa using a tree independent algorithm to retrieve diagnostic nucleotide 
characters from monolocus datasets. See the Manual for details:

https://github.com/SashaFedosov/MolD/blob/master/MolD_v1_3_manual.pdf

GUI versions for Windows an Linux are available at https://github.com/iTaxoTools/iTaxoTools-Executables/releases

**Quick Reference**
The parameter file is created by MolD-Galaxy according to the selected values or their defaults.  

*SET INPUT AND OUTPUT FILES (INCLUDING COMPLETE PATH)*

  - INPUT_FILE=Example_input_alignment_Pontohedyle_COI.fas
  - OUTPUT_FILE=result.txt

*SET TAXON PARAMETERS* (NO DEFAULTS, no parameters entered will lead to an error).

  - Set list of the focus taxa (enter a comma separated list WITHOUT SPACES)
  - or if each taxon is to be diagnosed, enter 'ALL'
  - or if all taxa with more than N sequences available (where N is a natural number), enter >N

qTAXA=ALL

*Set taxon rank: if species - 1, if above species - 2.*

Taxon_rank=-1

*Code gaps as characters: 'yes' or 'no'*

Gaps_as_chars=yes

*SET ADVANCED PARAMETERS FOR pDNC RECOVERY.* If you don't want to set them, don't enter anything after '='

  - Set number of the informative positions to be considered, integer (default 100)
  - or use '>'+integer to set desired cutoff value (for example '> 1')
  - Cutoff= > 10 needs space between > and 10

Cutoff=100

*Set how many ambiguously called nucleotides are allowed (default 25)*

NumberN=25

*Set number recursions of MolD (default 10000)*

Number_of_iterations=10000

*Set maximum length for the raw pDNCs (default 12)*

MaxLen1=12

#Set maximum length for the refined pDNCs (default 7)

MaxLen2=7

*SET PARAMETERS OF ARTIFICIAL DATASETS (only sDNSs).*
*Set percent difference between original and modified sequence (default 1 for species-level taxa, 3 for for supraspecific taxa).*

Pdiff=

*Set proportion of sequences in the dataset to be modified (default 0.5 for species-level, and 0.1 f#or supraspecific taxa).*

PrSeq=

*Set max number of sequences per taxon to modify (default 10)*

NMaxSeq=

*Set threshold of sDNC rating(default stringent).*
100 artificial datasets are created to score the sDNC. If the sDNC remains diagnostic in  requested (defined by value of threshold),
or higher number of artificial datasets in two consequtive runs, then sDNC is output. The threshold values are like:

  - lousy: 66
  - moderate: 75
  - stringent: 90
  - very_stringent: 95

Scoring=moderate

    ]]></help>
      <citations>
        <citation type="doi">
          10.1101/838151
        </citation>
        <citation type="doi">
            10.11646/megataxa.6.2.1 
        </citation>
      </citations>
</tool>