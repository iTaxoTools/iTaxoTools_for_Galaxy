<tool id="ASAP" name="ASAP" version="0.2.1+galaxy0" python_template_version="3.8" profile="22.05">
  <description>Agglomerate Specimens by Automatic Processing</description>
    <requirements></requirements>
    <command detect_errors="exit_code"><![CDATA[
        cp '$input1' '${os.path.splitext(os.path.basename($input1.name))[0]}' &&
        $__tool_directory__/asap 
           #if $opts.isMega: 
             -m 
          #end if
          #if $opts.output_all: 
             -a
          #end if
#* broken
          #if $distance=="-d 0": 
             -t $opts.transition 
          #end if
*#
          $distance
          #if $opts.replicates!=1000: 
            -r $opts.replicates
          #end if
          #if $opts.results!=10:
            -n $opts.results
          #end if
          #if $opts.pvalue!=0.001:
            -b $opts.pvalue
          #end if
#* broken

          #if $seed!=-1: 
             -x $opts.seed 
          #end if

*#

          '${os.path.splitext(os.path.basename($input1.name))[0]}'
          #if $spart_only: 
           -u &>'$output1'&&
          #else
            &>'$output1'&&
          #end if
         cp *.spart '$output2' &&
         cp *.xml '$output3'

#*
         #if $spart_only: 
           &&
           rm -f *.txt *.svg *.all
          #end if
*#          

    ]]></command>
    <inputs>
        <param  type="data" name="input1" label="Source file" format="fasta,phylip,csv" />
        <param name="spart_only" type="boolean" label="Only spart files" checked="true" help="Only the spart output is collected" />
        <param name="distance" type="select" label="Distance">
           <option value="-d 1">Jukes-Cantor</option>
           <option value="-d 0">Kimura-2P</option>
           <option value="-d 3">simple distance</option>
         </param>
        <section name="opts" title="Advanced options">
          <param name="output_all" type="boolean" label="Output all files"  help="all probabilities, tree and graph files (default only graph files and 10 best agglomerations)" />
          <param name="transition" type="float" label="transition/transversion"  value="2" help="(not used/broken) for Kimura (default is 2) " />       
          <param name="replicates" type="integer" label="number of replicates"  value="1000" help="for statistical tests (default is 10^3) " />
          <param name="pvalue" type="float" label="Pvalue"  value="0.001" help="Threshold for results to be reported (default is 0.001)"/>       
          <param name="seed" type="float" label="Seed"  value="-1" help="(not used/broken) Fixed seed for random generator (default -1 = random seed)"/>       
          <param name="results" type="integer" label="number of results"  value="10" help="best results to be reported (default is 10)" />        
          <param name="isMega" type="boolean" label="MEGA distance file" help="see MEGA information below" />

        </section>
    </inputs>
    <outputs>
      <data name="output1" label="${os.path.splitext(os.path.basename($input1.name))[0]}.log" format="txt">
        <filter> spart_only is False</filter> 
      </data>
      <data name="output2" label="${os.path.splitext(os.path.basename($input1.name))[0]}.spart" format="spart"/>
      <data name="output3" label="${os.path.splitext(os.path.basename($input1.name))[0]}.xml" format="xml"/>
      <data name="report" label="ASAP: ${os.path.splitext($input1.name)[0]}" format="svg" metadata_source="$input1">
        <discover_datasets pattern="(?P&lt;designation&gt;.+)\.svg" ext="svg" visible="true" />      
        <discover_datasets pattern="(?P&lt;designation&gt;.+)\.csv" ext="csv" visible="true" />  
        <discover_datasets pattern="(?P&lt;designation&gt;.+)\.txt" ext="txt" visible="true" />  
        <discover_datasets pattern="(?P&lt;designation&gt;.+)\.all" ext="tsv" visible="true" />  
        <discover_datasets pattern="partition" ext="txt" visible="true" />      
        <filter> spart_only is False</filter> 
      </data>
</outputs>
<tests>
    <test>
        <param name="input1" value="ASAP_examplefile1_LophiotomaCOI_iTaxoTools_0_1.fas"/>
        <param name="replicates" value="1000"/>
        <param name="results" value="10"/>
        <param name="distance" value="-d 1"/>
        <param name="spart_only" value="false"/>
        <param name="output_all" value="false"/>
        <output name="output1">
          <assert_contents>
            <has_text text="asap has finished building and testing all partitions"/>
          </assert_contents> 
        </output>
    </test>
</tests>



    <help><![CDATA[
**About ASAP:**

*This Galaxy version is based on the ASAP version from October 2022.* 

*Notes on Galaxy wrapper: Developed by F. Fischell in the framework of the iTaxoTools project in 2022/2023. Only tested for fasta alignment files. Transition and seed parameters are not currently supported. Tamura-Nei distance calculation is either really slow or broken, we recommend not using it.*

Standalone executables with graphical user interface of the newest version of ASAP are available for Windows and Mac from:

http://itaxotools.org/

https://github.com/iTaxoTools/iTaxoTools-Executables/releases

For detailed instructions on the use of ASAP and interpretation of results, see the iTaxoTools manual available at:
http://itaxotools.org/


**Source files:**
ASAP accepts three kinds of source files:

- fasta alignment
- phylip distance file
- MEGA distance file (see MEGA information below)

*Note: this Galaxy version has only been tested with fasta alignments  which we assume are the most common input files used. Refer to the standalone version or the ASAP website if you experience problems with other kinds of input files in the Galaxy version.*

**Purpose and results of ASAP analyses:**

ASAP is a program for species delimitation that uses genetic distances  derived from single-locus DNA sequence alignments to calculate species partitions. ASAP starts from genetic distances calculated between pairs of sequences, and successively groups them, first grouping the sequences with the least genetic distance, until all the sequences are clustered in a single group (i.e. following a hierarchical clustering approach). At each step where a new grouping occurs, ASAP will consider the corresponding partition and calculate a score, that is a combination of the probability of panmixia and the width of the barcode gap: the lower the score, the better the partition.
Each species partition consists of various subsets of individuals (sequences) that can be considered as primary species hypotheses. 

*Note 1: ASAP results should not be used to draw final taxonomic conclusions; primary species hypotheses derived from an ASAP analysis should always be confronted with additional lines of evidence, and should be used for proposing changes in the taxonomy of a group of organisms only if confirmed by such additional evidence (secondary species hypotheses).*

*Note 2: Partitions can be ranked according to ASAP scores (the lowest score marks the best partition) but depending on other lines of evidence, users may favor/select any of the other partitions.*

**Output:**

ASAP outputs a variety of files:

- Several graphs in SVG format. These cannot be visualized in Galaxy, but can be downloaded and opened in a browser or graphics program.
- A log file. 
- The calculated species partitions in SPART and SPART-XML format (Miralles et al. 2021)
- Separate text and table files for each species partition, with information on the assignment of individuals to subsets, andprobabilities and ASAP scores (the lowest ASAP score marks the best partition).


*Note: By default, the Galaxy version only outputs SPART and SPART-XML files to avoid cluttering the results panel with too many files. Change the sliding button for additional output. For additional detailed output and settings, use Advanced Options.* 

    ]]>
  </help>
  <citations>
    <citation type="doi">
      10.1111/1755-0998.13470
    </citation>
    <citation type="doi">
      10.1111/1755-0998.13281
    </citation>
    <citation type="doi">
        10.11646/megataxa.6.2.1 
    </citation>
  </citations>
</tool>